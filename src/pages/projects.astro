---
import { getCollection } from "astro:content";
import MainLayout from "../layouts/MainLayout.astro";
import ProjectCard from "../components/ProjectCard.astro";

const projects = await getCollection("projects");
projects.sort(
  (a, b) => b.data.startDate.valueOf() - a.data.startDate.valueOf()
);

// Get unique technologies for filtering, ordered by frequency
const technologyCounts = projects
  .flatMap((p) => p.data.technologies)
  .reduce(
    (acc, tech) => {
      acc[tech] = (acc[tech] || 0) + 1;
      return acc;
    },
    {} as Record<string, number>
  );

const allTechnologies = Object.keys(technologyCounts).sort(
  (a, b) => technologyCounts[b] - technologyCounts[a]
);
---

<MainLayout
  title="Projects - Francois Raminosona"
  description="Portfolio of mobile and cross-platform development projects showcasing expertise in Xamarin, .NET MAUI, and medical device software"
>
  <div class="bg-white dark:bg-slate-900 min-h-screen">
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-blue-600 to-teal-600 text-white py-16"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <h1 class="text-4xl font-bold mb-4">Projects</h1>
          <p class="text-xl text-blue-100 max-w-3xl mx-auto">
            A showcase of software development projects that I have worked on.
          </p>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Filter Section -->
      <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          Filter by Technology
        </h2>
        <div class="flex flex-wrap gap-2" id="technology-filters">
          <button
            class="filter-btn active px-4 py-2 rounded-full border border-brand-contrast text-brand-contrast hover:bg-brand-light hover:text-white hover:border-brand-light transition-colors"
            data-filter="all"
          >
            All Projects
          </button>
          {
            allTechnologies.map((tech) => (
              <button
                class="filter-btn px-4 py-2 rounded-full border border-brand-contrast text-brand-contrast hover:bg-brand-light hover:text-white hover:border-brand-light transition-colors"
                data-filter={tech.toLowerCase().replace(/[^a-z0-9]/g, "-")}
              >
                {tech}
              </button>
            ))
          }
        </div>
      </div>

      <!-- All Projects -->
      <section>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
          All Projects
        </h2>
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
          id="projects-grid"
        >
          {
            projects.map((project) => (
              <div
                class="project-card"
                data-technologies={project.data.technologies
                  .map((t) => t.toLowerCase().replace(/[^a-z0-9]/g, "-"))
                  .join(" ")}
              >
                <ProjectCard project={project} />
              </div>
            ))
          }
        </div>
      </section>
    </div>
  </div>
</MainLayout>

<script>
  // Project filtering functionality
  document.addEventListener("DOMContentLoaded", function () {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const projectCards = document.querySelectorAll(".project-card");

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const filter = button.getAttribute("data-filter");

        // Update active button
        filterButtons.forEach((btn) =>
          btn.classList.remove(
            "active",
            "bg-brand-light",
            "text-white",
            "border-brand-light"
          )
        );
        button.classList.add(
          "active",
          "bg-brand-light",
          "text-white",
          "border-brand-light"
        );

        // Filter projects
        projectCards.forEach((card) => {
          const htmlCard = card as HTMLElement;
          if (filter === "all") {
            htmlCard.style.display = "block";
          } else {
            const cardTechnologies = htmlCard.getAttribute("data-technologies");
            if (cardTechnologies && filter && cardTechnologies.includes(filter)) {
              htmlCard.style.display = "block";
            } else {
              htmlCard.style.display = "none";
            }
          }
        });
      });
    });
  });
</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .filter-btn.active {
    @apply bg-brand-light text-white border-brand-light;
  }
</style>
