---
import { getCollection } from "astro:content";
import MainLayout from "../layouts/MainLayout.astro";
import HackathonCard from "../components/HackathonCard.astro";

// Calculated from start date of 2012 to today
const xpYears = new Date().getFullYear() - 2012;

const hackathons = await getCollection("hackathons");
hackathons.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get unique technologies for filtering, ordered by frequency
const technologyCounts = hackathons
  .flatMap((h) => h.data.technologies)
  .reduce(
    (acc, tech) => {
      acc[tech] = (acc[tech] || 0) + 1;
      return acc;
    },
    {} as Record<string, number>
  );

const allTechnologies = Object.keys(technologyCounts).sort(
  (a, b) => technologyCounts[b] - technologyCounts[a]
);

// Categorize hackathons by type
const winners = hackathons.filter(
  (h) => h.data.tags && h.data.tags.includes("Victory")
);
const jury = hackathons.filter(
  (h) =>
    h.data.tags &&
    (h.data.tags.includes("Jury") || h.data.tags.includes("Judge"))
);
const coaching = hackathons.filter(
  (h) =>
    h.data.tags &&
    (h.data.tags.includes("Coach") || h.data.tags.includes("Mentor"))
);

// Get years for timeline
const years = [
  ...new Set(hackathons.map((h) => h.data.date.getFullYear())),
].sort((a: number, b: number) => b - a);
---

<MainLayout
  title="Hackathons - Francois Raminosona"
  description="Comprehensive collection of hackathon experiences spanning 12+ years, from participant victories to coaching and mentoring roles in technology innovation competitions"
>
  <div class="bg-white dark:bg-slate-900 min-h-screen">
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-16"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <h1 class="text-4xl font-bold mb-4">Hackathons & Competitions</h1>
          <p class="text-xl text-purple-100 max-w-3xl mx-auto">
            {xpYears} years of innovation competitions, from national victories to
            mentoring teams, through being a judge and co-organizer.
          </p>
          <div class="mt-8 flex flex-wrap justify-center gap-6 text-lg">
            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-2">
              üèÜ <span class="font-bold">{winners.length}</span> Victories
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-2">
              üë®‚Äçüè´ <span class="font-bold">{coaching.length}</span> Coaching Roles
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-2">
              ‚öñÔ∏è <span class="font-bold">{jury.length}</span> Jury Roles
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-2">
              <span class="font-bold">{hackathons.length}</span> Total Events
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Filter Section -->
      <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          Filter Hackathons
        </h2>

        <!-- Technology Filters -->
        <div class="mb-6">
          <h3
            class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            By Technology
          </h3>
          <div class="flex flex-wrap gap-2" id="technology-filters">
            <button
              class="filter-btn active px-4 py-2 rounded-full border border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white transition-colors active bg-purple-600 text-white"
              data-filter="all"
              data-type="technology"
            >
              All Technologies
            </button>
            {
              allTechnologies.slice(0, 10).map((tech: string) => (
                <button
                  class="filter-btn px-4 py-2 rounded-full border border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white transition-colors"
                  data-filter={tech.toLowerCase().replace(/[^a-z0-9]/g, "-")}
                  data-type="technology"
                >
                  {tech}
                </button>
              ))
            }
          </div>
        </div>

        <!-- Year Filters -->
        <div class="mb-6">
          <h3
            class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            By Year
          </h3>
          <div class="flex flex-wrap gap-2" id="year-filters">
            <button
              class="filter-btn active px-4 py-2 rounded-full border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white transition-colors active bg-blue-600 text-white"
              data-filter="all"
              data-type="year"
            >
              All Years
            </button>
            {
              years.map((year: number) => (
                <button
                  class="filter-btn px-4 py-2 rounded-full border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white transition-colors"
                  data-filter={year.toString()}
                  data-type="year"
                >
                  {year}
                </button>
              ))
            }
          </div>
        </div>

        <!-- Role Filters -->
        <div class="mb-6">
          <h3
            class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            By Role
          </h3>
          <div class="flex flex-wrap gap-2" id="role-filters">
            <button
              class="filter-btn active px-4 py-2 rounded-full border border-green-600 text-green-600 hover:bg-green-600 hover:text-white transition-colors active bg-green-600 text-white"
              data-filter="all"
              data-type="role"
            >
              All Roles
            </button>
            <button
              class="filter-btn px-4 py-2 rounded-full border border-green-600 text-green-600 hover:bg-green-600 hover:text-white transition-colors"
              data-filter="winner"
              data-type="role"
            >
              üèÜ Winners
            </button>
            <button
              class="filter-btn px-4 py-2 rounded-full border border-green-600 text-green-600 hover:bg-green-600 hover:text-white transition-colors"
              data-filter="coach"
              data-type="role"
            >
              üë®‚Äçüè´ Coach/Mentor
            </button>
            <button
              class="filter-btn px-4 py-2 rounded-full border border-green-600 text-green-600 hover:bg-green-600 hover:text-white transition-colors"
              data-filter="jury"
              data-type="role"
            >
              ‚öñÔ∏è Jury
            </button>
          </div>
        </div>
      </div>

      <!-- All Hackathons -->
      <section>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
          All Hackathons & Competitions
        </h2>
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
          id="hackathons-grid"
        >
          {
            hackathons.map((hackathon) => (
              <HackathonCard hackathon={hackathon} />
            ))
          }
        </div>
      </section>
    </div>
  </div>
</MainLayout>

<script>
  // Hackathon filtering functionality
  document.addEventListener("DOMContentLoaded", function () {
    const hackathonCards = document.querySelectorAll(".hackathon-card");
    let activeFilters = {
      technology: "all",
      year: "all",
      role: "all",
    };

    function filterHackathons() {
      hackathonCards.forEach((card) => {
        const htmlCard = card as HTMLElement;
        const cardTechnologies =
          htmlCard.getAttribute("data-technologies") || "";
        const cardYear = htmlCard.getAttribute("data-year") || "";
        const cardRole = htmlCard.getAttribute("data-role") || "";

        const techMatch =
          activeFilters.technology === "all" ||
          cardTechnologies.includes(activeFilters.technology);
        const yearMatch =
          activeFilters.year === "all" || cardYear === activeFilters.year;
        const roleMatch =
          activeFilters.role === "all" || cardRole === activeFilters.role;

        if (techMatch && yearMatch && roleMatch) {
          htmlCard.style.display = "block";
        } else {
          htmlCard.style.display = "none";
        }
      });
    }

    // Set up filter buttons
    document.querySelectorAll(".filter-btn").forEach((button) => {
      button.addEventListener("click", () => {
        const filter = button.getAttribute("data-filter");
        const type = button.getAttribute("data-type");

        // Update active button in the same category
        const categoryButtons = document.querySelectorAll(
          `[data-type="${type}"]`
        );
        categoryButtons.forEach((btn) => {
          btn.classList.remove("active");
          if (type === "technology") {
            btn.classList.remove("bg-purple-600", "text-white");
            btn.classList.add("text-purple-600");
          } else if (type === "year") {
            btn.classList.remove("bg-blue-600", "text-white");
            btn.classList.add("text-blue-600");
          } else if (type === "role") {
            btn.classList.remove("bg-green-600", "text-white");
            btn.classList.add("text-green-600");
          }
        });

        button.classList.add("active");
        if (type === "technology") {
          button.classList.add("bg-purple-600", "text-white");
          button.classList.remove("text-purple-600");
        } else if (type === "year") {
          button.classList.add("bg-blue-600", "text-white");
          button.classList.remove("text-blue-600");
        } else if (type === "role") {
          button.classList.add("bg-green-600", "text-white");
          button.classList.remove("text-green-600");
        }

        // Update active filters
        if (type) {
          activeFilters[type as keyof typeof activeFilters] = filter || "all";
        }
        filterHackathons();
      });
    });
  });
</script>

<style>
  .filter-btn.active {
    font-weight: 600;
  }
</style>
